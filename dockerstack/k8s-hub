ARG IMAGE_NAME
ARG IMAGE_TAG
ARG RHEL_VERSION
ARG REPOSITORY_URL
ARG PYTHON_VERSION=3.10.12
# jovyan user details
ARG NB_USER=jovyan
ARG NB_UID=1000
ARG NB_HOME=/home/jovyan
ARG JUPYTERHUB_DIR=/srv/jupyterhub
ARG PYCURL_SSL_LIBRARY=openssl

FROM redhat/ubi9:latest as build

# use bash as the default shell for this image
SHELL ["/bin/bash", "-l", "-c"]

# jovyan user details
ARG NB_USER
ARG NB_UID
ARG NB_HOME
ARG JUPYTERHUB_DIR
ARG PYCURL_SSL_LIBRARY

# requirements location
ARG REQUIREMENTS=/tmp/requirements.txt

USER root

ARG PYTHON_VERSION

# Install required packages
# Update the base system
RUN yum upgrade -y --nodocs && \
    yum -y --allowerasing install --nodocs \
    make \
    zlib-devel \
    bzip2 bzip2-devel \
    sqlite sqlite-devel \
    openssl-devel \
    libffi-devel \
    gcc gcc-c++ \
    procps \
    libcurl-devel \
    xz xz-devel \
    git \
    # nodejs \
    # npm \
    ncurses-devel \
    tar \
    findutils \
    postgresql-devel \
    yum \
    dnf
RUN yum --nogpgcheck --repofrompath=centos,https://mirror.stream.centos.org/9-stream/AppStream/x86_64/os -y \
    install readline-devel

# add jovyan user
RUN useradd -u ${NB_UID} -d ${NB_HOME} ${NB_USER} && \
    mkdir -p ${JUPYTERHUB_DIR} && \
    chown ${NB_USER}:${NB_USER} ${JUPYTERHUB_DIR}

# Install pyenv using pyenv-installer
## set $PYENV_ROOT to choose the install directory
ENV PYENV_ROOT=/opt/.pyenv \
    VIRTUAL_ENV=/opt/.pyenv/versions/${PYTHON_VERSION}

## pyevn installation
RUN curl -L https://github.com/pyenv/pyenv-installer/raw/master/bin/pyenv-installer | bash

# setup pyenv ENV variables
RUN echo 'export PYENV_ROOT="$PYENV_ROOT"' >> ~/.bashrc && \
    echo 'export PATH="$PYENV_ROOT/bin:$PATH"' >> ~/.bashrc && \
    echo -e 'if command -v pyenv 1>/dev/null 2>&1; then\n eval "$(pyenv init -)"\nfi' >> ~/.bashrc

# install python of chosen version
RUN pyenv install ${PYTHON_VERSION}

# remove *.pem files in test directory
RUN find /opt/.pyenv/versions/${PYTHON_VERSION}/lib/python*/test \
    -name "*.pem" -type f -delete


# choose global python version
RUN pyenv global ${PYTHON_VERSION}

# Copy project requirements.in file
COPY --chown=$NB_USER:root hub/requirements.in /home/${NB_USER}/requirements.in

# Prepare python environment
ARG INDEX_URL

# Prepare and install jupyterhub python dependencies
RUN pip install pip-tools && \
    pip-compile /home/${NB_USER}/requirements.in && \
    pip install -r /home/${NB_USER}/requirements.txt

# Copy jwtauthenticator
# COPY hub/jwtauthenticator ${VIRTUAL_ENV}/lib/jwtauthenticator

# Update pip, setuptools
RUN pip install --no-cache-dir --upgrade setuptools certifi && \
    pip install --no-cache-dir --upgrade wheel python-json-logger cryptography && \
    # pip install --no-cache-dir -e ${VIRTUAL_ENV}/lib/jwtauthenticator && \
    pip uninstall pip --yes

# remove dependency test secrets
RUN PY_MAJOR_VER=$(echo ${PYTHON_VERSION} | cut -d. -f1) && \
    PY_MINOR_VER=$(echo ${PYTHON_VERSION} | cut -d. -f2) && \
    PYTHON_VERSION_NO_PATCH=${PY_MAJOR_VER}.${PY_MINOR_VER} && \
    echo ${PYTHON_VERSION_NO_PATCH} && \
    find /opt/.pyenv/versions/${PYTHON_VERSION}/lib/python${PYTHON_VERSION_NO_PATCH}/site-packages/tornado/test \
    -name "*.key" -type f -delete
    # rm -rf /opt/.pyenv/versions/${PYTHON_VERSION}/lib/python${PYTHON_VERSION_NO_PATCH}/site-packages/tornado/test
    

# FINAL IMAGE
FROM redhat/ubi9:latest
# use bash as the default shell for this image
SHELL ["/bin/bash", "-l", "-c"]

USER root

ARG PYTHON_VERSION
ARG NB_USER
ARG NB_UID
ARG NB_HOME
ARG JUPYTERHUB_DIR
ARG PYCURL_SSL_LIBRARY

# Install required packages
# Update the base system
RUN yum upgrade -y --nodocs && \
    yum -y --allowerasing install --nodocs \
    make \
    zlib-devel \
    bzip2 bzip2-devel \
    sqlite sqlite-devel \
    openssl-devel \
    libffi-devel \
    gcc gcc-c++ \
    procps \
    libcurl-devel \
    xz xz-devel \
    git \
    # nodejs \
    # npm \
    ncurses-devel

# Install nvm
# Instructions:
#   https://github.com/nvm-sh/nvm/issues/1533
#   https://github.com/nvm-sh/nvm#git-install
ENV NVM_DIR=/opt/.nvm
ENV NVM_PROFILE=/etc/profile.d/nvm.sh

RUN groupadd nvm && \
    usermod -aG nvm root && \
    mkdir ${NVM_DIR} && \
    chown :nvm ${NVM_DIR} && \
    chmod g+ws ${NVM_DIR}

WORKDIR ${NVM_DIR}
RUN git clone https://github.com/nvm-sh/nvm.git "$NVM_DIR" && \
    git checkout `git describe --abbrev=0 --tags --match "v[0-9]*" $(git rev-list --tags --max-count=1)`

RUN mkdir ${NVM_DIR}/.cache && \
    mkdir ${NVM_DIR}/versions && \
    mkdir ${NVM_DIR}/alias && \
    chmod -R g+ws ${NVM_DIR}/.cache && \
    chmod -R g+ws ${NVM_DIR}/versions && \
    chmod -R g+ws ${NVM_DIR}/alias

RUN echo 'export NVM_DIR="/opt/.nvm"' > ${NVM_PROFILE} && \
    echo '[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"' >${NVM_PROFILE} && \
    chmod +x ${NVM_PROFILE}

# Install newest nodejs using nvm, set it as default.
RUN nvm install node && \
    nvm alias default node

# install proxy
RUN npm install -g configurable-http-proxy@^4.2.0

# add jovyan user
RUN useradd -u ${NB_UID} -d ${NB_HOME} ${NB_USER} && \
    mkdir -p ${JUPYTERHUB_DIR} && \
    chown ${NB_USER}:${NB_USER} ${JUPYTERHUB_DIR}

# add jovyan user to nvm group
RUN usermod -aG nvm ${NB_USER}

ENV PYENV_ROOT=/opt/.pyenv \
    VIRTUAL_ENV=/opt/.pyenv/versions/${PYTHON_VERSION}

# copy python distribution
COPY --from=build --chown=$NB_USER:root $VIRTUAL_ENV $VIRTUAL_ENV

# back to default sh as the default shell for this image
SHELL ["/bin/sh", "-c"]

# build complete, now run the jupyterhub
WORKDIR ${JUPYTERHUB_DIR}

# JupyterHub API port
EXPOSE 8081

HEALTHCHECK --start-period=10s CMD bash -c '</dev/tcp/127.0.0.1/8081 &>/dev/null' || exit 1

USER ${NB_USER}

# SETUP PYTHON PATHS
ENV PATH="${VIRTUAL_ENV}/bin:${PATH}"

CMD ["jupyterhub", "--config", "/usr/local/etc/jupyterhub/jupyterhub_config.py"]




